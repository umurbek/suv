{% extends 'base.html' %}

{% block content %}
<div class="p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">Yangi buyurtmalar</h2>
        <div class="text-sm text-gray-500">Siz: {% if courier %}{{ courier.full_name }}{% else %}—{% endif %}</div>
    </div>

    <div id="newOrdersContainer" class="space-y-4">
        {% if new_orders %}
            {% for o in new_orders %}
            <div class="bg-white p-4 rounded shadow flex justify-between items-start border border-gray-100">
                <div>
                    <div class="font-medium">#{{ o.id }} — {{ o.client }}</div>
                    <div class="text-xs text-gray-500">{{ o.phone }} • {{ o.date|date:"Y-m-d H:i" }}</div>
                    {% if o.note %}<div class="text-xs mt-1">{{ o.note }}</div>{% endif %}
                </div>
                <div class="text-right">
                    {% if o.lat and o.lon %}
                    <a href="https://www.google.com/maps/search/?api=1&query={{ o.lat }},{{ o.lon }}" target="_blank" class="inline-block bg-gray-100 px-3 py-1 rounded text-xs mr-2 hover:bg-gray-200">Navigatsiya</a>
                    {% else %}
                    <span class="inline-block bg-gray-100 px-3 py-1 rounded text-xs mr-2 opacity-50">Joylashuv yo‘q</span>
                    {% endif %}
                    <button class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-xs" onclick="acceptStatic({{ o.id }}, this)">Qabul qilish</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-gray-500">Yangi buyurtma yo'q</div>
        {% endif %}
    </div>
</div>

{% block extra_scripts %}
<script>
// Minimal, robust JS for accepting orders (dev friendly)
async function acceptStatic(orderId, btn){
    btn.disabled = true; btn.innerText = 'Qabul qilinmoqda...';
    try{
        const r = await fetch('/courier_panel/api/accept_order/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({order_id: orderId}), credentials: 'same-origin'});
        const res = await r.json();
        if (res.status === 'ok'){
            const card = btn.closest('.bg-white'); if (card) card.remove();
            btn.innerText = 'Qabul qilindi';
        } else if (res.message && res.message.toLowerCase().includes('courier not found')){
            alert('Courier not found in session. Use /courier_panel/dev/login_as/<id> to set a courier id.');
            btn.disabled=false; btn.innerText='Qabul qilish';
        } else {
            alert('Xato: ' + (res.message||'')); btn.disabled=false; btn.innerText='Qabul qilish';
        }
    }catch(e){ console.error(e); btn.disabled=false; btn.innerText='Qabul qilish'; }
}
</script>
{% endblock %}

{% endblock %}
