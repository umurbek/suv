{% extends 'base.html' %}

{% block content %}
<div class="p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">Yangi buyurtmalar</h2>
        <div class="text-sm text-gray-500">Siz: {% if courier %}{{ courier.full_name }}{% else %}—{% endif %}</div>
    </div>

    <div id="newOrdersContainer" class="space-y-4">
        {% if new_orders %}
            {% for o in new_orders %}
            <div class="bg-white p-4 rounded shadow flex justify-between items-start">
                <div>
                    <div class="font-medium">#{{ o.id }} — {{ o.client }}</div>
                    <div class="text-xs text-gray-500">{{ o.phone }} • {{ o.date|date:"Y-m-d H:i" }}</div>
                    {% if o.note %}<div class="text-xs mt-1">{{ o.note }}</div>{% endif %}
                </div>
                <div class="text-right">
                    {% if o.lat and o.lon %}
                    <a href="https://www.google.com/maps/search/?api=1&query={{ o.lat }},{{ o.lon }}" target="_blank" class="inline-block bg-gray-100 px-3 py-1 rounded text-xs mr-2">Navigatsiya</a>
                    {% else %}
                    <span class="inline-block bg-gray-100 px-3 py-1 rounded text-xs mr-2 opacity-50">Joylashuv yo‘q</span>
                    {% endif %}
                    <button class="bg-blue-500 text-white px-3 py-1 rounded text-xs" onclick="acceptStatic({{ o.id }}, this)">Qabul qilish</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-gray-500">Yangi buyurtma yo'q</div>
        {% endif %}
    </div>
</div>

{% block extra_scripts %}
<script>
// helper: update the sidebar new-orders badge
function updateNewOrdersBadge(n){
    try{
        const badge = document.getElementById('newOrdersBadge');
        if (!badge) return;
        const count = (typeof n === 'number') ? n : (n && n.length ? n.length : 0);
        if (count > 0){ badge.innerText = count>9 ? '9+' : String(count); badge.classList.remove('hidden'); }
        else { badge.classList.add('hidden'); }
    } catch(e){ console.error('badge helper error', e); }
}

async function loadNewOrders() {
    try {
        const resp = await fetch('/courier_panel/api/new_orders/');
        const j = await resp.json();
        const container = document.getElementById('newOrdersContainer');
        // update sidebar badge based on returned data
        if (j && j.status === 'ok' && j.data) updateNewOrdersBadge(j.data.length);
        // If API returned no new orders, clear any server-rendered samples and show empty message
        if (j.status !== 'ok' || !j.data || j.data.length === 0) {
            updateNewOrdersBadge(0);
            container.innerHTML = '<div class="text-gray-500">Yangi buyurtma yo\'q</div>';
            return;
        }
        // Replace with live data
        container.innerHTML = '';
        j.data.forEach(o => {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded shadow flex justify-between items-start';
            const left = document.createElement('div');
            left.innerHTML = `<div class="font-medium">#${o.id} — ${o.client || 'Anonim'}</div><div class="text-xs text-gray-500">${o.phone || ''} • ${new Date(o.date).toLocaleString()}</div><div class="mt-1 text-xs">${o.note || ''}</div>`;
            const right = document.createElement('div');
            right.className = 'text-right';
            const nav = document.createElement('a');
            nav.className = 'inline-block bg-gray-100 px-3 py-1 rounded text-xs mr-2';
            if (o.lat && o.lon) { nav.href = `https://www.google.com/maps/search/?api=1&query=${o.lat},${o.lon}`; nav.target='_blank'; nav.innerText='Navigatsiya'; } else { nav.innerText='Joylashuv yo‘q'; nav.className += ' opacity-50'; }
            const accept = document.createElement('button');
            accept.className = 'bg-blue-500 text-white px-3 py-1 rounded text-xs';
            accept.innerText = 'Qabul qilish';
            accept.onclick = async () => {
                accept.disabled = true; accept.innerText='Qabul qilinmoqda...';
                try {
                    const r = await fetch('/courier_panel/api/accept_order/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({order_id: o.id})});
                    const res = await r.json();
                    if (res.status === 'ok') {
                        // remove this card from DOM immediately for better UX
                        card.remove();
                        // update badge count and if there are no more cards, show empty message
                        const remaining = container.querySelectorAll('.bg-white').length;
                        updateNewOrdersBadge(remaining);
                        if (!remaining) {
                            container.innerHTML = '<div class="text-gray-500">Yangi buyurtma yo\'q</div>';
                        }
                    } else {
                        alert('Xato: ' + (res.message||'')); accept.disabled=false; accept.innerText='Qabul qilish';
                    }
                } catch(e) { console.error(e); accept.disabled=false; accept.innerText='Qabul qilish'; }
            };
            right.appendChild(nav);
            right.appendChild(accept);
            card.appendChild(left);
            card.appendChild(right);
            container.appendChild(card);
        });
    } catch (e) { console.error(e); }
}

loadNewOrders();
setInterval(loadNewOrders, 5000);
// helper for static sample accept buttons
async function acceptStatic(orderId, btn) {
    btn.disabled = true; btn.innerText = 'Qabul qilinmoqda...';
    try {
        const r = await fetch('/courier_panel/api/accept_order/', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({order_id: orderId})});
        const res = await r.json();
        if (res.status === 'ok') {
            // remove server-rendered static card immediately
            const card = btn.closest('.bg-white');
            if (card) card.remove();
            btn.innerText = 'Qabul qilindi';
            const container = document.getElementById('newOrdersContainer');
            const remaining = container ? container.querySelectorAll('.bg-white').length : 0;
            updateNewOrdersBadge(remaining);
            if (container && !remaining) container.innerHTML = '<div class="text-gray-500">Yangi buyurtma yo\'q</div>';
        } else {
            alert('Xato: ' + (res.message||'')); btn.disabled=false; btn.innerText='Qabul qilish';
        }
    } catch (e) { console.error(e); btn.disabled=false; btn.innerText='Qabul qilish'; }
}
</script>
{% endblock %}

{% endblock %}
