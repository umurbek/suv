{% extends 'base.html' %}

{% block content %}
<div class="px-4 py-8 max-w-7xl mx-auto">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
        <div>
            <h1 class="text-3xl font-black text-white tracking-tight">
                {{ T.orders_page_title|default:'Buyurtmalar Paneli' }}
            </h1>
            <p class="text-slate-400 text-sm mt-1">Barcha buyurtmalar va mijozlar oqimi</p>
        </div>
        
        <div class="flex items-center gap-3 bg-[#0f172a] p-2 rounded-2xl border border-white/10 w-full md:w-auto">
            <div class="pl-3 text-slate-500">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
            <input id="order-search" 
                   class="bg-transparent border-none text-white focus:ring-0 text-sm w-full md:w-64 placeholder:text-slate-600" 
                   placeholder="{{ T.search_placeholder|default:'Ism, telefon yoki manzil...' }}" />
            <button id="clear-search" class="bg-white/5 hover:bg-white/10 text-slate-300 px-4 py-2 rounded-xl text-xs font-bold transition-all">
                {{ T.clear|default:'Tozalash' }}
            </button>
        </div>
    </div>

    {# Flash notification area #}
    {% if flash_message %}
    <div id="flash-message" class="fixed top-24 right-6 z-50 animate-bounce">
        <div class="px-6 py-4 rounded-2xl shadow-2xl border backdrop-blur-xl {% if flash_type == 'success' %}bg-emerald-500/20 border-emerald-500/50 text-emerald-400{% elif flash_type == 'danger' %}bg-red-500/20 border-red-500/50 text-red-400{% else %}bg-blue-500/20 border-blue-500/50 text-blue-400{% endif %}">
            <div class="flex items-center gap-3">
                <i class="fa-solid {% if flash_type == 'success' %}fa-check-circle{% else %}fa-circle-info{% endif %} text-xl"></i>
                <span class="font-bold">{{ flash_message }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div class="lg:col-span-3">
            <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for o in orders %}
                <div class="group bg-[#0f172a] border border-white/5 rounded-3xl p-6 hover:border-blue-500/50 transition-all duration-300 shadow-xl relative overflow-hidden" 
                     data-lat="{{ o.lat|default:'' }}" data-lon="{{ o.lon|default:'' }}">
                    
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-500/5 blur-3xl group-hover:bg-blue-500/10 transition-all"></div>

                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center text-blue-400 border border-white/5 shadow-inner font-bold">
                                {{ o.client_name|slice:":1"|upper }}
                            </div>
                            <div>
                                <h3 class="text-white font-bold group-hover:text-blue-400 transition-colors">{{ o.client_name }}</h3>
                                <p class="text-[10px] text-slate-500 font-mono tracking-tighter uppercase">{{ o.order_label }}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            {% if o.status_label %}
                            <span class="px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-wider {{ o.status_class }} border border-current opacity-80">
                                {{ o.status_label }}
                            </span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="space-y-4 mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 rounded-2xl bg-white/[0.02] border border-white/5">
                                <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Aloqa</p>
                                <p class="text-sm text-slate-200 font-semibold">{{ o.phone }}</p>
                            </div>
                            <div class="p-3 rounded-2xl bg-white/[0.02] border border-white/5">
                                <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">To'lov</p>
                                <p class="text-sm text-emerald-400 font-bold">{{ o.amount|default:'0' }} <span class="text-[10px]">UZS</span></p>
                            </div>
                        </div>

                        <div class="p-3 rounded-2xl bg-white/[0.02] border border-white/5 relative">
                            <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Manzil</p>
                            <p class="text-sm text-slate-300 leading-tight pr-12">{{ o.address }}</p>
                            <button type="button" class="open-map-btn absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-blue-500/10 text-blue-500 hover:bg-blue-500 hover:text-white transition-all flex items-center justify-center" 
                                    data-address="{{ o.address|escapejs }}" data-lat="{{ o.lat|default:'' }}" data-lon="{{ o.lon|default:'' }}">
                                <i class="fa-solid fa-location-dot"></i>
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between px-2 text-xs">
                            <span class="text-slate-500"><i class="fa-solid fa-truck-fast mr-1"></i> {{ o.courier|default:'Tayinlanmagan' }}</span>
                            <span class="text-slate-500"><i class="fa-solid fa-bottle-water mr-1 text-blue-500"></i> {{ o.bottles }} ta</span>
                        </div>
                    </div>

                    <div class="flex gap-2">
                        {% if o.client_id %}
                        <a href="{% url 'edit_client' client_id=o.client_id %}" class="w-full text-center py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-white text-xs font-bold transition-all border border-white/5">
                            {{ T.edit_client|default:'Mijozni tahrirlash' }}
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full py-20 text-center">
                    <div class="text-6xl mb-4">Empty</div>
                    <p class="text-slate-500">Hech qanday buyurtma topilmadi.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <aside class="space-y-6">
            <div class="bg-[#0f172a] rounded-3xl p-6 border border-white/5">
                <div class="flex items-center gap-2 mb-6">
                    <i class="fa-solid fa-crown text-amber-500"></i>
                    <h4 class="font-bold text-white uppercase text-xs tracking-widest">Top Mijozlar</h4>
                </div>
                <div class="space-y-4">
                    {% for c in top_clients %}
                    <div class="flex items-center justify-between group">
                        <span class="text-sm text-slate-400 group-hover:text-white transition-colors">{{ c.client__full_name }}</span>
                        <span class="bg-blue-500/10 text-blue-400 px-2 py-1 rounded text-[10px] font-black">{{ c.orders_count }} TA</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-[#0f172a] rounded-3xl p-6 border border-white/5">
                <div class="flex items-center gap-2 mb-6">
                    <i class="fa-solid fa-bolt text-blue-500"></i>
                    <h4 class="font-bold text-white uppercase text-xs tracking-widest">Top Kuryerlar</h4>
                </div>
                <div class="space-y-4">
                    {% for k in top_couriers %}
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-400">{{ k.courier__full_name }}</span>
                        <div class="flex items-center gap-2">
                            <div class="w-16 h-1 bg-slate-800 rounded-full overflow-hidden">
                                <div class="bg-emerald-500 h-full" style="width: 80%"></div>
                            </div>
                            <span class="text-[10px] font-bold text-emerald-400">{{ k.delivered }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-6 text-white">
                <h4 class="font-bold uppercase text-xs tracking-widest mb-6 opacity-80">Hududlar bo'yicha</h4>
                <div class="space-y-4">
                    {% for r in region_stats %}
                    <div class="flex justify-between items-center bg-white/10 p-3 rounded-2xl backdrop-blur-sm">
                        <span class="text-xs font-bold">{{ r.client__region__name|default:'Nomaâ€™lum' }}</span>
                        <span class="text-xs bg-white text-blue-700 px-2 py-0.5 rounded-full font-black">{{ r.total_orders }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </aside>
    </div>
</div>

<div id="order-map-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4">
    <div class="w-full max-w-4xl bg-[#0f172a] rounded-[2rem] overflow-hidden border border-white/10 shadow-2xl">
        <div class="flex items-center justify-between p-6 border-b border-white/5">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-map-location-dot text-blue-500 text-xl"></i>
                <h3 class="font-bold text-white">{{ T.map_modal_title|default:'Joylashuv xaritada' }}</h3>
            </div>
            <button id="order-map-close" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-red-500/20 hover:text-red-500 text-slate-400 transition-all flex items-center justify-center">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div id="order-map" class="h-[500px] w-full"></div>
    </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Search & Flash Logic (unchanged functionality, just clean)
    const search = document.getElementById('order-search');
    const clearBtn = document.getElementById('clear-search');
    const cards = Array.from(document.querySelectorAll('#orders-grid > div'));

    search.addEventListener('input', () => {
        const q = search.value.trim().toLowerCase();
        cards.forEach(c => {
            const isVisible = c.textContent.toLowerCase().includes(q);
            c.style.display = isVisible ? '' : 'none';
        });
    });

    clearBtn.addEventListener('click', () => { 
        search.value = ''; 
        cards.forEach(c => c.style.display = ''); 
    });

    // Map Logic (Enhanced UI)
    let orderMap = null;
    let orderMapMarker = null;

    function openOrderMap(lat, lon, address){
        const modal = document.getElementById('order-map-modal');
        modal.classList.remove('hidden');
        if (!orderMap){
            orderMap = L.map('order-map', { zoomControl: false }).setView([41.2995,69.2401], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(orderMap);
            L.control.zoom({ position: 'bottomright' }).addTo(orderMap);
        }
        
        if (lat && lon){
            const ll = [parseFloat(lat), parseFloat(lon)];
            orderMap.setView(ll, 16);
            if (orderMapMarker) orderMap.removeLayer(orderMapMarker);
            orderMapMarker = L.marker(ll).addTo(orderMap).bindPopup(`<div class="p-2 font-bold">${address}</div>`).openPopup();
        }
    }

    document.addEventListener('click', function(ev){
        const btn = ev.target.closest('.open-map-btn');
        if (btn){
            openOrderMap(btn.dataset.lat, btn.dataset.lon, btn.dataset.address);
        }
        if (ev.target.id === 'order-map-close' || ev.target.id === 'order-map-modal'){
            document.getElementById('order-map-modal').classList.add('hidden');
        }
    });
</script>
{% endblock %}