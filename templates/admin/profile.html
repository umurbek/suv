{% extends 'base.html' %}

{% block title %}Admin Profil{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 pb-24">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2">
            <div class="bg-gradient-to-r from-indigo-900/60 to-blue-800/50 backdrop-blur-md text-white rounded-2xl p-6 shadow-2xl border border-white/5">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-tr from-blue-400 to-cyan-400 flex items-center justify-center text-3xl shadow-lg text-white font-bold">
                        {% if request.user.is_authenticated %}{{ request.user.username|slice:":1"|upper }}{% else %}A{% endif %}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-xl">{% if request.user.is_authenticated %}{{ request.user.username }}{% else %}Administrator{% endif %}</div>
                        <div class="text-sm opacity-80 mt-1">Admin profilini tahrirlash</div>
                    </div>
                    <a href="/admin_panel/dashboard/" class="text-sm text-slate-200 bg-white/5 hover:bg-white/10 px-3 py-2 rounded-lg">Ortga</a>
                </div>
            </div>

            <div class="mt-6 bg-white/5 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-white/6">
                <h2 class="text-lg font-semibold text-white mb-4">Ma'lumotlarni tahrirlash</h2>
                <form id="admin-profile-form">
                    <label for="admin_name" class="block text-sm font-medium text-gray-300 mb-1">Ism</label>
                    <input name="admin_name" id="admin_name" value="{% if request.user.is_authenticated %}{{ request.user.first_name|default:request.user.username }}{% endif %}" class="w-full p-3 border border-white/10 rounded-lg mb-3 bg-transparent text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">

            <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Login (username)</label>
            <input name="username" id="username" value="{% if request.user.is_authenticated %}{{ request.user.username }}{% endif %}" class="w-full p-3 border border-white/10 rounded-lg mb-3 bg-transparent text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">

            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input name="email" id="email" value="{% if request.user.is_authenticated %}{{ request.user.email }}{% endif %}" class="w-full p-3 border border-white/10 rounded-lg mb-3 bg-transparent text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">

            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Yangi parol (ixtiyoriy)</label>
            <div class="relative mb-3">
                <input name="password" id="password" type="password" placeholder="Yangi parol" aria-label="Yangi parol" class="w-full pr-12 p-3 border border-white/10 rounded-lg mb-0 bg-slate-800/60 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200">
                <button type="button" id="toggle-password-btn" aria-pressed="false" aria-label="Parolni ko'rsat / yashirish" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 bg-white/5 hover:bg-white/10 w-9 h-9 rounded-md flex items-center justify-center">
                    <i id="toggle-password-icon" class="fa-solid fa-eye"></i>
                </button>
            </div>

                    <div class="flex gap-3 mt-4">
                        <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg shadow-md">Saqlash</button>
                        <a href="/admin_panel/dashboard/" class="flex-1 text-center border border-white/10 p-3 rounded-lg text-slate-300 hover:bg-white/5">Bekor</a>
                    </div>
                </form>
            </div>
        </div>

        <aside class="space-y-6">
            <div class="bg-white/5 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-white/6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-users-gear text-indigo-400"></i>
                        Barcha Adminlar
                    </h3>
                    <span class="bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-full text-xs font-bold">{{ total_admins }} ta</span>
                </div>
                <div class="space-y-3">
                    {% for admin in all_admins %}
                    <div class="p-4 bg-white/[0.03] hover:bg-white/[0.08] border border-white/5 rounded-xl transition-all group">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-500 to-blue-500 flex items-center justify-center text-white font-bold shadow-lg">
                                {{ admin.full_name|slice:":1"|upper }}
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white group-hover:text-blue-400 transition-colors">{{ admin.full_name }}</div>
                                <div class="text-xs text-slate-400 font-mono">{{ admin.phone }}</div>
                                {% if admin.telegram_id %}
                                <div class="text-xs text-emerald-400 mt-1">
                                    <i class="fa-brands fa-telegram"></i> Telegram ulangan
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-8 text-slate-500">
                        <i class="fa-solid fa-users text-3xl mb-2"></i>
                        <p>Admin topilmadi</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </aside>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.getElementById('admin-profile-form').addEventListener('submit', async function(ev){
    ev.preventDefault();
    const btn = this.querySelector('button[type="submit"]');
    const old = btn.innerHTML; btn.disabled = true; btn.innerHTML = 'Saqlanmoqda...';

    const fd = new FormData(this);
    
    // Toast notification function
    const showToast = (message, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `fixed top-6 right-6 z-[9999] px-6 py-4 rounded-2xl shadow-2xl border backdrop-blur-xl ${
            type === 'success' 
                ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-400' 
                : 'bg-red-500/20 border-red-500/50 text-red-400'
        }`;
        toast.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} text-xl"></i>
                <span class="font-bold">${message}</span>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    };
    
    try{
        const resp = await fetch('/admin_panel/api/update_profile/', { 
            method: 'POST', 
            body: fd, 
            credentials: 'same-origin' 
        });
        const j = await resp.json();
        console.log('Response:', j);
        
        if(j && j.status === 'ok'){
            showToast(j.message || 'Profil muvaffaqiyatli saqlandi!', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showToast((j && j.message) || 'Xatolik yuz berdi', 'error');
            btn.disabled = false; btn.innerHTML = old;
        }
    }catch(e){
        showToast('Server bilan aloqa yo\'q', 'error');
        btn.disabled = false; btn.innerHTML = old;
    }
});
    // Password toggle for admin profile (updates aria-pressed)
    (function(){
        const btn = document.getElementById('toggle-password-btn');
        const input = document.getElementById('password');
        const icon = document.getElementById('toggle-password-icon');
        if(!btn || !input || !icon) return;
        btn.addEventListener('click', function(){
            const isHidden = input.type === 'password';
            if(isHidden){
                input.type = 'text';
                icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
                btn.setAttribute('aria-pressed', 'true');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
                btn.setAttribute('aria-pressed', 'false');
            }
            // keep focus on input after toggle for a smoother UX
            try{ input.focus(); }catch(e){}
        });
    })();
</script>
{% endblock %}
