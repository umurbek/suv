{% extends 'base.html' %}
{% block content %}

<div class="px-6 py-6 bg-[#0f172a] min-h-screen text-white">
  <div class="flex items-center justify-between mb-8">
    <h1 class="text-2xl font-bold text-white">Mijozlar profillari</h1>

    <div class="flex items-center gap-2">
      <div class="flex items-center gap-2">
        <input type="file" id="excelInputMain" accept=".xlsx" class="hidden" onchange="excelPicked(this)">
        
        <button type="button" onclick="openExcelHelp()" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-bold">
          Excel yuklash
        </button>

        <button type="button" id="importBtn" onclick="startUploadWithProgress()" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-all">
          Import
        </button>
      </div>
    </div>
  </div>

  <div id="progressWrapper" class="hidden w-full bg-gray-800 rounded-full h-6 overflow-hidden border border-gray-700 mb-6">
      <div id="progressBar" class="bg-blue-500 h-full text-xs font-bold text-white flex items-center justify-center transition-all" style="width: 0%">0%</div>
  </div>

  </div>

<div id="excelHelpModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
  <div class="bg-[#0b1220] rounded-2xl w-full max-w-2xl p-6 border border-slate-700">
    <h2 class="text-2xl font-black mb-4 text-emerald-400">Excel yuklash formati</h2>
    <p class="text-sm text-slate-400 mb-4">Fayl <b>.xlsx</b> bo'lishi va 1-qator headerlari quyidagicha bo'lishi shart:</p>
    <div class="bg-slate-900 p-4 rounded-lg border border-slate-700 mb-6 font-mono text-xs">
        full_name | bottle_soni | manzili | phone
    </div>
    <div class="flex justify-end gap-3">
      <button onclick="closeExcelHelp()" class="px-5 py-2 rounded-lg bg-slate-700 text-white">Bekor</button>
      <button onclick="selectExcelFile()" class="px-5 py-2 rounded-lg bg-blue-600 text-white font-bold">Faylni tanlash</button>
    </div>
  </div>
</div>

<script>
  function openExcelHelp() { document.getElementById('excelHelpModal').classList.replace('hidden', 'flex'); }
  function closeExcelHelp() { document.getElementById('excelHelpModal').classList.replace('flex', 'hidden'); }
  function selectExcelFile() { document.getElementById("excelInputMain").click(); }

  function excelPicked(input) {
    if (input.files.length > 0) {
      closeExcelHelp();
      const btn = document.getElementById('importBtn');
      btn.innerText = "Tayyor: " + input.files[0].name.substring(0, 10) + "...";
      btn.classList.replace('bg-blue-600', 'bg-emerald-600');
    }
  }

  function startUploadWithProgress() {
    const fileInput = document.getElementById('excelInputMain');
    const importBtn = document.getElementById('importBtn');
    const wrapper = document.getElementById('progressWrapper');
    const bar = document.getElementById('progressBar');

    if (fileInput.files.length === 0) {
      alert("Iltimos, avval faylni tanlang!");
      return;
    }

    const formData = new FormData();
    formData.append('excel_file', fileInput.files[0]);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    const xhr = new XMLHttpRequest();
    wrapper.classList.remove('hidden');
    importBtn.disabled = true;

    xhr.upload.onprogress = function(e) {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        bar.style.width = percent + '%';
        bar.innerText = percent + '%';
        if (percent === 100) bar.innerText = "Saqlanmoqda...";
      }
    };

    xhr.onload = function() {
      if (xhr.status === 200) {
        window.location.reload();
      } else {
        alert("Xato yuz berdi!");
        wrapper.classList.add('hidden');
        importBtn.disabled = false;
      }
    };

    xhr.open('POST', "{% url 'admin_panel:clients_upload_excel' %}", true);
    xhr.send(formData);
  }
</script>

{% endblock %}