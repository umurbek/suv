<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Kirish</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        .input-focus {
            transition: all 0.2s ease-in-out;
        }
        .input-focus:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            outline: none;
        }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-4">
    <div class="glass-card p-10 rounded-2xl shadow-2xl w-full max-w-md border border-gray-100">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Xush kelibsiz</h1>
            <p class="text-gray-500 mt-2">Tizimga kirish uchun ma'lumotlarni kiriting</p>
        </div>

        <form method="POST" action="{% url 'login' %}" id="role-form" novalidate class="space-y-5">
            {% csrf_token %}
            
            <div id="form-error">
                {% if error %}
                <div class="p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded text-sm animate-pulse">
                    {{ error }}
                </div>
                {% endif %}
            </div>

            <div>
                <label for="role" class="block text-sm font-semibold text-gray-700 mb-1">Foydalanuvchi turi</label>
                <select id="role" name="role" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 text-gray-900 input-focus cursor-pointer">
                    <option value="admin" {% if selected_role == 'admin' %}selected{% endif %}>Admin</option>
                    <option value="courier" {% if selected_role == 'courier' %}selected{% endif %}>Kuryer (Courier)</option>
                    <option value="client" {% if selected_role == 'client' %}selected{% endif %}>Mijoz (Client)</option>
                </select>
            </div>

            <hr class="border-gray-100">

            <div id="admin-fields" class="role-fields space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">To'liq ism</label>
                    <input type="text" id="admin-name" name="admin_name" placeholder="Masalan: Ali Valiyev" value="{{ admin_name|default:'' }}" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 input-focus">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Telefon raqam (Ixtiyoriy)</label>
                    <input type="text" id="admin-phone" name="admin_phone" placeholder="+998901234567" value="{{ admin_phone|default:'' }}" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 input-focus">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Login</label>
                    <input type="text" id="admin-user" name="username" value="{{ username|default:'admin' }}" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 input-focus">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Parol</label>
                    <div class="relative">
                        <input type="password" id="password" name="password" placeholder="••••••••" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 input-focus">
                        <button type="button" id="toggle-login-password" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-900">
                            <i id="toggle-login-icon" class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="courier-fields" class="role-fields hidden space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Kuryer ismi</label>
                    <input type="text" id="courier-name" name="courier_name" placeholder="Ism va familiya" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 input-focus">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Telefon raqam</label>
                    <input type="text" id="courier-phone" name="courier_phone" value="+998" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 input-focus">
                </div>
            </div>

            <div id="client-fields" class="role-fields hidden space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">To'liq ism</label>
                    <input type="text" id="client-name" name="client_name" placeholder="Ism va familiya" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 input-focus">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Telefon raqam</label>
                    <input type="text" id="client-phone" name="phone" value="+998" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2.5 input-focus">
                </div>
                <input type="hidden" id="location-lat" name="location_lat" value="">
                <input type="hidden" id="location-lon" name="location_lon" value="">
            </div>

            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:from-blue-700 hover:to-indigo-700 transition duration-300 transform hover:-translate-y-0.5 active:scale-95 mt-6">
                Davom etish
            </button>
        </form>

        <p class="text-center text-xs text-gray-400 mt-8">
            &copy; 2025 Delivery System. Barcha huquqlar himoyalangan.
        </p>
    </div>

<script>
// Logic qismi o'zgarishsiz qoldi, faqat UI bilan bog'liq kichik tuzatishlar
const roleSelect = document.getElementById('role');
function updateFields() {
    const role = roleSelect.value;
    document.querySelectorAll('.role-fields').forEach(el => el.classList.add('hidden'));
    
    const adminFields = document.querySelectorAll('#admin-fields input');
    const courierFields = document.querySelectorAll('#courier-fields input');
    const clientFields = document.querySelectorAll('#client-fields input');

    [...adminFields, ...courierFields, ...clientFields].forEach(i => i.required = false);

    if (role === 'admin') {
        document.getElementById('admin-fields').classList.remove('hidden');
        adminFields.forEach(i => { if(i.id !== 'admin-phone') i.required = true; });
    } else if (role === 'courier') {
        document.getElementById('courier-fields').classList.remove('hidden');
        courierFields.forEach(i => i.required = true);
    } else if (role === 'client') {
        document.getElementById('client-fields').classList.remove('hidden');
        clientFields.forEach(i => i.required = true);
    }
}

roleSelect.addEventListener('change', updateFields);
window.onload = updateFields;

// Form Submit handling (Sizning mavjud JS kodingiz...)
const form = document.getElementById('role-form');
form.addEventListener('submit', async function (ev) {
    ev.preventDefault();
    function showError(msg){
        const container = document.getElementById('form-error');
        container.innerHTML = `<div class="p-4 mb-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded text-sm">${msg}</div>`;
    }
    
    // ... (Sizning qolgan JS validatsiya va Fetch kodingiz bu yerda davom etadi)
    // Yuqoridagi JS kodingizni aynan shu yerga qo'shib qo'ying.
    
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
        <svg class="animate-spin h-5 w-5 mr-3 inline-block text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg> Yuklanmoqda...`;

    // Fetch qismini va manzil olishni o'zingizning kodingizdek davom ettiring
    const fd = new FormData(form);
    const role = roleSelect.value;

    if (role === 'client' && navigator.geolocation) {
        const pos = await new Promise(resolve => {
            navigator.geolocation.getCurrentPosition(p => resolve(p), () => resolve(null), {timeout: 5000});
        });
        if (pos) {
            fd.set('location_lat', pos.coords.latitude);
            fd.set('location_lon', pos.coords.longitude);
        }
    }

    try {
        const resp = await fetch(form.action || window.location.pathname, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: fd
        });
        const data = await resp.json();
        if (data.status === 'ok') {
            window.location.href = data.next;
        } else {
            showError(data.message || 'Xatolik yuz berdi');
            submitBtn.disabled = false;
            submitBtn.innerText = 'Davom etish';
        }
    } catch (err) {
        showError('Tarmoq xatosi yuz berdi');
        submitBtn.disabled = false;
        submitBtn.innerText = 'Davom etish';
    }
});
// Toggle login password visibility
(function(){
    const btn = document.getElementById('toggle-login-password');
    const input = document.getElementById('password');
    const icon = document.getElementById('toggle-login-icon');
    if(!btn || !input || !icon) return;
    btn.addEventListener('click', function(){
        if(input.type === 'password'){
            input.type = 'text';
            icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
        }
    });
})();
</script>
</body>
</html>