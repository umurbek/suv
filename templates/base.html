<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}CRM Admin{% endblock %}</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    {% block extra_head %}{% endblock %}
</head>
<body class="font-sans bg-gray-50 text-gray-900">

<div class="flex">

    <!-- SIDEBAR (desktop) -->
    <aside id="sidebar" class="w-64 h-screen bg-blue-900 text-white p-6 flex flex-col justify-between fixed hidden md:flex">

        <div>
            <div class="flex items-center space-x-3 mb-6">
                {% if request.session.courier_id and request.path|slice:"0:15" == '/courier_panel/' %}
                <span class="text-3xl">ğŸš´</span>
                <div>
                    <h1 class="text-2xl font-bold">Kuryer Paneli</h1>
                    <p class="text-xs text-white/80">Kuryer: {{ request.session.courier_name|default:'Anonim' }} â€¢ {{ request.session.courier_phone|default:'' }}</p>
                </div>
                {% elif request.session.client_id and request.path|slice:"0:14" == '/client_panel/' %}
                <span class="text-3xl">ğŸ‘¤</span>
                <div>
                    <h1 class="text-2xl font-bold">Mening Dashboard</h1>
                    <p class="text-xs text-white/80">{% if request.session.customer_id %}Customer ID: {{ request.session.customer_id }}{% endif %}{% if request.session.client_name %} â€¢ {{ request.session.client_name }}{% endif %}{% if request.session.client_phone %} â€¢ {{ request.session.client_phone }}{% endif %}</p>
                </div>
                {% else %}
                <span class="text-3xl">ğŸ’§</span>
                <div>
                    <h1 class="text-2xl font-bold">CRM Admin</h1>
                    <p class="text-xs text-white/80">{% if request.session.admin_name %}{{ request.session.admin_name }}{% else %}Suv yetkazib berish{% endif %}{% if request.session.admin_phone %} â€¢ {{ request.session.admin_phone }}{% endif %}</p>
                </div>
                {% endif %}
            </div>

            {% if request.session.courier_id and request.path|slice:"0:15" == '/courier_panel/' %}
            <ul class="space-y-3">
                <li>
                    <a href="/courier_panel/dashboard/" class="block px-3 py-2 rounded-lg {% if request.path == '/courier_panel/dashboard/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ  Mening dashboard</a>
                </li>
                <li>
                    <a href="/courier_panel/new_orders/" class="relative block px-3 py-2 rounded-lg {% if request.path == '/courier_panel/new_orders/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">
                        ğŸ†• Yangi buyurtmalar
                        <span id="newOrdersBadge" class="hidden absolute -top-2 right-2 bg-red-600 text-white text-xs font-semibold rounded-full px-1.5 py-0.5">0</span>
                    </a>
                </li>
                <li>
                    <a href="/courier_panel/history/" class="block px-3 py-2 rounded-lg {% if request.path == '/courier_panel/history/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ“œ Qilingan ishlar tarixi</a>
                </li>
                <li>
                    <a href="/courier_panel/contact_admin/" class="block px-3 py-2 rounded-lg {% if request.path == '/courier_panel/contact_admin/' or request.session.last_view == 'contact_admin' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">âœ‰ï¸ Admin bilan aloqa</a>
                </li>
            </ul>
            {% elif request.session.client_id and request.path|slice:"0:14" == '/client_panel/' %}
            <ul class="space-y-3">
                <li>
                    <a href="/client_panel/dashboard/" class="block px-3 py-2 rounded-lg {% if request.path == '/client_panel/dashboard/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ  Mening dashboard</a>
                </li>
                <li>
                    <a href="/client_panel/profile/" class="block px-3 py-2 rounded-lg {% if request.path == '/client_panel/profile/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ‘¤ Profil</a>
                </li>
                <li>
                    <a href="/client_panel/orders/" class="block px-3 py-2 rounded-lg {% if request.path == '/client_panel/orders/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ“¦ Buyurtmalar</a>
                </li>
                <li>
                    <a href="/client_panel/contact_admin/" class="block px-3 py-2 rounded-lg {% if request.path == '/client_panel/contact_admin/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">âœ‰ï¸ Yordam</a>
                </li>
            </ul>
            {% else %}
            <ul class="space-y-3">
                <li>
                    <a href="/admin_panel/dashboard/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/dashboard/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ  Boshqaruv paneli</a>
                </li>
                <li>
                    <a href="/admin_panel/regions/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/regions/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ—ºï¸ Hududlar</a>
                </li>
                <li>
                    <a href="/admin_panel/couriers/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/couriers/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸšš Kuryerlar</a>
                </li>
                <li>
                    <a href="/admin_panel/orders/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/orders/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ“¦ Buyurtmalar</a>
                </li>
                <li>
                    <a href="/admin_panel/reports/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/reports/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ“Š Hisobotlar</a>
                </li>

                <!-- Qarzdorlar link with separate 10+ button underneath -->
                <li>
                    <a href="/admin_panel/debtors/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/debtors/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">
                        <div class="flex items-center space-x-2">
                            <span>ğŸ“ˆ</span>
                            <span class="font-semibold">Qarzdorlar</span>
                        </div>
                    </a>
                </li>
                <li class="ml-4">
                    <a href="/admin_panel/inactive/10days/" class="block px-3 py-1 rounded-md text-sm {% if request.path == '/admin_panel/inactive/10days/' %}bg-yellow-600 text-white{% else %}bg-yellow-100 text-yellow-800 hover:bg-yellow-200{% endif %}">
                        10+ kun buyurtma yo'q
                    </a>
                </li>
            </ul>
            {% endif %}

        </div>

        <div>
            <a href="/logout/" class="block bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-center">ğŸ“¤ Chiqish</a>
        </div>

    </aside>

    <!-- Mobile top bar (small screens) -->
    <div class="w-full md:hidden bg-white border-b p-3 fixed z-30">
        <div class="flex items-center justify-between">
            {% if not request.session.client_id or request.path|slice:"0:14" != '/client_panel/' %}
            <button id="mobile-menu-btn" class="p-2 rounded bg-blue-600 text-white">
                â˜°
            </button>
            {% endif %}
            <div class="flex items-center space-x-2">
                <!-- static logo (replace later) -->
                <img src="/static/img/logo.png" alt="logo" class="h-7 w-7 object-contain" onerror="this.style.display='none'" />
                <div class="text-lg font-semibold">Suv yetkazib berish</div>
            </div>
            <div class="flex items-center space-x-2">
                <!-- Mobile quick order button -->
                <button id="mobile-order-btn" class="p-2 rounded bg-blue-600 text-white ml-2 md:hidden">ğŸ›’</button>
            </div>
            <div></div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main-content" class="ml-0 md:ml-64 w-full p-6 pt-20 md:pt-6">
        {% block content %}{% endblock %}
    </div>

</div>

<!-- Mobile off-canvas sidebar (small screens) -->
{% if not request.session.client_id or request.path|slice:"0:14" != '/client_panel/' %}
<div id="mobile-sidebar-overlay" class="hidden fixed inset-0 bg-black/40 z-40"></div>
<aside id="mobile-sidebar" class="hidden fixed inset-y-0 left-0 w-64 bg-blue-900 text-white p-6 z-50 overflow-auto">
    <!-- Duplicate of sidebar content for mobile drawer -->
    <div>
        <div class="flex items-center space-x-3 mb-6">
            <span class="text-3xl">ğŸ’§</span>
            <div>
                <h1 class="text-2xl font-bold">CRM Admin</h1>
                <p class="text-xs text-white/80">{% if request.session.admin_name %}{{ request.session.admin_name }}{% else %}Suv yetkazib berish{% endif %}{% if request.session.admin_phone %} â€¢ {{ request.session.admin_phone }}{% endif %}</p>
            </div>
        </div>

        <ul class="space-y-3">
            <li>
                <a href="/admin_panel/dashboard/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/dashboard/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ  Boshqaruv paneli</a>
            </li>
            <li>
                <a href="/admin_panel/regions/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/regions/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ—ºï¸ Hududlar</a>
            </li>
            <li>
                <a href="/admin_panel/couriers/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/couriers/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸšš Kuryerlar</a>
            </li>
            <li>
                <a href="/admin_panel/orders/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/orders/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ“¦ Buyurtmalar</a>
            </li>
            <li>
                <a href="/admin_panel/reports/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/reports/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">ğŸ“Š Hisobotlar</a>
            </li>
            <li>
                <a href="/admin_panel/debtors/" class="block px-3 py-2 rounded-lg {% if request.path == '/admin_panel/debtors/' %}bg-blue-600{% else %}bg-blue-700 hover:bg-blue-600{% endif %}">
                    <div class="flex items-center space-x-2">
                        <span>ğŸ“ˆ</span>
                        <span class="font-semibold">Qarzdorlar</span>
                    </div>
                </a>
            </li>
            <li class="ml-4">
                <a href="/admin_panel/inactive/10days/" class="block px-3 py-1 rounded-md text-sm {% if request.path == '/admin_panel/inactive/10days/' %}bg-yellow-600 text-white{% else %}bg-yellow-100 text-yellow-800 hover:bg-yellow-200{% endif %}">10+ kun buyurtma yo'q</a>
            </li>
        </ul>
    </div>
    <div>
        <a href="/logout/" class="block bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-center mt-6">ğŸ“¤ Chiqish</a>
    </div>
</aside>
{% endif %}

{% block extra_scripts %}
<script>
// Mobile sidebar toggle
document.addEventListener('DOMContentLoaded', function(){
    const btn = document.getElementById('mobile-menu-btn');
    const mobile = document.getElementById('mobile-sidebar');
    const overlay = document.getElementById('mobile-sidebar-overlay');
    if (!btn || !mobile) return;
    const open = () => { mobile.classList.remove('hidden'); overlay.classList.remove('hidden'); document.body.classList.add('overflow-hidden'); };
    const close = () => { mobile.classList.add('hidden'); overlay.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); };
    btn.addEventListener('click', open);
    overlay.addEventListener('click', close);
    // close when route changes via sidebar links
    mobile.querySelectorAll('a').forEach(a => a.addEventListener('click', close));
});
</script>
{% endblock %}

<!-- Global courier badge poller: updates sidebar badge on any courier page -->
<script>
document.addEventListener('DOMContentLoaded', function(){
    // only run on courier pages where the badge exists
    if (!window.location.pathname.startsWith('/courier_panel/')) return;
    const badge = () => document.getElementById('newOrdersBadge');
    async function pollBadge(){
        try{
            const resp = await fetch('/courier_panel/api/new_orders/');
            const j = await resp.json();
            if (j && j.status === 'ok'){
                const b = badge();
                if (!b) return;
                const n = Array.isArray(j.data) ? j.data.length : 0;
                if (n > 0) { b.innerText = n > 9 ? '9+' : String(n); b.classList.remove('hidden'); }
                else { b.classList.add('hidden'); }
            }
        } catch (e){ /* ignore network errors silently */ console.error('badge poll error', e); }
    }
    // initial fetch and interval
    pollBadge();
    setInterval(pollBadge, 7000);
});
</script>

    {# Mobile bottom navigation for client pages (visible on small screens) #}
    {% if request.session.client_id and request.path|slice:"0:14" == '/client_panel/' %}
    <nav class="fixed inset-x-0 bottom-0 bg-white border-t md:hidden z-40">
        <div class="max-w-md mx-auto flex justify-between items-center px-4 py-2">
            <a href="/client_panel/dashboard/" class="flex flex-col items-center text-xs text-gray-700 {% if request.path == '/client_panel/dashboard/' %}text-blue-600{% endif %}">
                <div class="text-2xl">ğŸ </div>
                <div>Asosiy</div>
            </a>
            <a href="/client_panel/dashboard/#products" class="flex flex-col items-center text-xs text-gray-700">
                <div class="text-2xl">ğŸ›’</div>
                <div>Buyurtma</div>
            </a>
            <a href="/client_panel/orders/" class="flex flex-col items-center text-xs text-gray-700 {% if request.path == '/client_panel/orders/' %}text-blue-600{% endif %}">
                <div class="text-2xl">ğŸ•˜</div>
                <div>Tarix</div>
            </a>
            <a href="/client_panel/profile/" class="flex flex-col items-center text-xs text-gray-700 {% if request.path == '/client_panel/profile/' %}text-blue-600{% endif %}">
                <div class="text-2xl">ğŸ‘¤</div>
                <div>Profil</div>
            </a>
        </div>
    </nav>
    <!-- Floating action order button (visible on client pages) -->
    <button id="fab-order-btn" aria-label="Buyurtma berish" class="fixed bottom-24 right-4 md:right-8 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-2xl shadow-lg z-50">ğŸ›’</button>
    {% endif %}
</body>
</html>
